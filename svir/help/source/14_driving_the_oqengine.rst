.. _chap-drive-oq-engine:

****************************
Driving the OpenQuake Engine
****************************

The plugin enables to drive the OpenQuake Engine, submitting new jobs, watching
calculation progress, retrieving and visualizing results, seamlessly within the
QGIS interface. This is made possible by leveraging the OpenQuake Engine
Server's `HTTP RESTful API
<https://github.com/gem/oq-engine/blob/master/doc/web-api.md>`_.
The connection with a running OQ-Engine Server has to be properly set up as described
in :ref:`chap-irmt-settings`. The server can run locally in the same computer where
QGIS is running, or remotely. For instance, it is possible to connect to a remote
cluster, to perform jobs that are highly demanding in terms of computational resources.


Run a calculation
===================

When the :guilabel:`Run Calculation` button is pressed, a file explorer is opened,
enabling to select the input files needed to run the job (or a zip archive
containing them), including the `job.ini` file. By pressing :guilabel:`Open` to confirm,
the job is submitted. The interface keeps querying the server asynchronously, and
displaying the status of the calculation.


Watch the console log
=====================

It is possible to watch the log of a calculation, by pressing the
:guilabel:`Console` button in the corresponding row. The log will be displayed
in a tab of the QGIS :guilabel:`Log Message Panel`.  

.. FIXME add figure


Download outputs
================

If a calculation was completed successfully, an :guilabel:`Outputs` button is
provided. When it is clicked, the list of available outputs is shown, which
depends on the type of artifacts generated by the calculation. Outputs can be
downloaded in one of the available formats, by clicking the corresponding
button. In some cases, they can also be loaded as QGIS layers, and a default
styling is applied, based on parameters chosen by the user.

.. FIXME add figure


Run a risk calculation on top of hazard
=======================================

To run a risk-only calculation on top of a previous hazard run you have to
click the :guilabel:`Run Risk` button on the corresponding hazard calculation
and select the zip file containing the risk `job.ini` and the related inputs.

.. FIXME add figure


Remove a calculation
====================

To hide a calculation from the list press the :guilabel:`Remove` button.

.. FIXME add figure

The calculation is removed from the calculations list, but it is not actually
removed from the database nor from the datastore.


Calculation status
==================

The :guilabel:`Status` column of the :guilabel:`List of calculations` indicates
the current status of a calculation, which can be one of the following:
`created`, `executing`, `complete`, `failed`.

.. FIXME add figure

The reason behind a `failed` calculation can be inspected by watching the
console log, by means of the :guilabel:`Console` button.
